<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jiho's Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            border: 'hsl(var(--border))',
            background: 'hsl(var(--background))',
            foreground: 'hsl(var(--foreground))',
            card: { DEFAULT: 'hsl(var(--card))', foreground: 'hsl(var(--card-foreground))' },
            muted: { DEFAULT: 'hsl(var(--muted))', foreground: 'hsl(var(--muted-foreground))' },
            accent: { DEFAULT: 'hsl(var(--accent))', foreground: 'hsl(var(--accent-foreground))' },
          },
          borderRadius: { lg: '0.5rem', md: 'calc(0.5rem - 2px)', sm: 'calc(0.5rem - 4px)' },
        }
      }
    }
  </script>
  <style>
    :root {
      --background: 0 0% 100%;
      --foreground: 240 10% 3.9%;
      --card: 0 0% 100%;
      --card-foreground: 240 10% 3.9%;
      --muted: 240 4.8% 95.9%;
      --muted-foreground: 240 3.8% 46.1%;
      --border: 240 5.9% 90%;
      --accent: 240 4.8% 95.9%;
    }
    .dark {
      --background: 240 10% 3.9%;
      --foreground: 0 0% 98%;
      --card: 240 10% 3.9%;
      --card-foreground: 0 0% 98%;
      --muted: 240 3.7% 15.9%;
      --muted-foreground: 240 5% 64.9%;
      --border: 240 3.7% 15.9%;
      --accent: 240 3.7% 15.9%;
    }
    body { font-family: 'Inter', system-ui, sans-serif; }

    .ts::-webkit-scrollbar { height: 6px; }
    .ts::-webkit-scrollbar-track { background: hsl(var(--muted)); border-radius: 3px; }
    .ts::-webkit-scrollbar-thumb { background: hsl(var(--muted-foreground) / 0.3); border-radius: 3px; }
    .ts::-webkit-scrollbar-thumb:hover { background: hsl(var(--muted-foreground) / 0.5); }

    .gantt-bar { transition: filter 0.15s, opacity 0.15s; }
    .gantt-bar:hover { filter: brightness(1.15); opacity: 0.9; }

    .bar-stripe {
      background-image: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(239,68,68,0.08) 3px, rgba(239,68,68,0.08) 6px);
    }
    .dark .bar-stripe {
      background-image: repeating-linear-gradient(45deg, transparent, transparent 3px, rgba(239,68,68,0.15) 3px, rgba(239,68,68,0.15) 6px);
    }
    .bar-dash {
      background-image: repeating-linear-gradient(90deg, hsl(var(--muted-foreground) / 0.15), hsl(var(--muted-foreground) / 0.15) 6px, transparent 6px, transparent 10px);
    }

    @keyframes now-pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
    .now-dot { animation: now-pulse 2s ease-in-out infinite; }

    /* Drag handles */
    .drag-handle { opacity: 0; transition: opacity 0.15s; }
    .gantt-bar:hover .drag-handle { opacity: 1; }
    body.dragging { user-select: none !important; }
    body.dragging * { cursor: col-resize !important; }
    body.dragging .gantt-bar { filter: none; opacity: 1; pointer-events: none; }

    /* Expand arrow */
    .expand-arrow { transition: transform 0.15s ease; }
    .expand-arrow.open { transform: rotate(90deg); }
  </style>
</head>
<body class="min-h-screen bg-background text-foreground antialiased">
  <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6">

    <!-- Header -->
    <header class="mb-5">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">Jiho's Dashboard</h1>
          <p class="mt-0.5 text-sm text-muted-foreground">ì‘ì—… í˜„í™©ì„ íƒ€ì„ë¼ì¸ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
        <div class="flex items-center gap-3">
          <div id="live" class="flex items-center gap-1.5 text-xs text-muted-foreground">
            <span class="relative flex h-2.5 w-2.5">
              <span class="animate-ping absolute h-full w-full rounded-full bg-green-400 opacity-75"></span>
              <span class="relative rounded-full h-2.5 w-2.5 bg-green-500"></span>
            </span>
            <span>Live</span>
          </div>
          <button id="themeBtn" class="rounded-md border border-border p-2 text-muted-foreground hover:bg-accent transition-colors">
            <svg id="moonIco" class="h-4 w-4 hidden" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 006.002-2.082 9.718 9.718 0 003-3.916z"/></svg>
            <svg id="sunIco" class="h-4 w-4 hidden" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Controls -->
    <div class="flex items-center justify-between mb-3 flex-wrap gap-2">
      <div class="flex items-center gap-1.5">
        <button onclick="nav(-1)" class="rounded-md border border-border p-1.5 hover:bg-accent transition-colors">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/></svg>
        </button>
        <button onclick="goToday()" class="rounded-md border border-border px-3 py-1.5 text-xs font-medium hover:bg-accent transition-colors">ì˜¤ëŠ˜</button>
        <button onclick="nav(1)" class="rounded-md border border-border p-1.5 hover:bg-accent transition-colors">
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/></svg>
        </button>
        <span id="rangeLabel" class="ml-2 text-sm font-semibold"></span>
      </div>
      <div class="flex rounded-lg border border-border overflow-hidden" id="zoomBar"></div>
    </div>

    <!-- Gantt Chart -->
    <div class="rounded-lg border border-border bg-card shadow-sm overflow-hidden">
      <div class="flex">
        <!-- Left: Labels -->
        <div class="w-48 sm:w-56 shrink-0 border-r border-border bg-card z-10" id="labelPanel">
          <div class="h-10 border-b border-border px-3 flex items-center">
            <span class="text-[11px] font-semibold text-muted-foreground uppercase tracking-wider">ì‘ì—…</span>
          </div>
          <div id="labels"></div>
        </div>
        <!-- Right: Timeline -->
        <div class="flex-1 overflow-x-auto ts" id="tScroll">
          <div id="tWrap" class="relative">
            <div class="h-10 border-b border-border flex" id="tHeader"></div>
            <div class="relative" id="tBody"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Schedule -->
    <div class="mt-3 rounded-lg border border-border bg-card shadow-sm p-4">
      <h2 class="text-sm font-semibold mb-2.5 flex items-center gap-1.5">
        <span>ğŸ“…</span> ì˜¤ëŠ˜ ì¼ì •
      </h2>
      <div id="sched" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Footer -->
    <footer class="mt-5 text-center text-xs text-muted-foreground">
      30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹  Â· â† â†’ í‚¤ë¡œ íƒìƒ‰ Â· Powered by GitHub Pages
    </footer>
  </div>

  <!-- Tooltip -->
  <div id="tip" class="hidden fixed z-50 max-w-xs rounded-lg border border-border bg-card shadow-lg p-3 text-sm pointer-events-none"></div>

  <!-- Drag Tooltip -->
  <div id="dragTip" class="hidden fixed z-[60] rounded-md border border-blue-500/50 bg-card shadow-lg px-2.5 py-1 text-xs font-mono font-semibold text-blue-500 pointer-events-none"></div>

  <script>
  /* â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const ZOOMS = [
    { id:'1d', label:'1ì¼', days:1,  step:1,  unit:'hour', cpx:50  },
    { id:'3d', label:'3ì¼', days:3,  step:1,  unit:'hour', cpx:24  },
    { id:'1w', label:'1ì£¼', days:7,  step:7,  unit:'day',  cpx:120 },
    { id:'2w', label:'2ì£¼', days:14, step:7,  unit:'day',  cpx:72  },
    { id:'1m', label:'1ë‹¬', days:30, step:30, unit:'day',  cpx:38  },
  ];

  const CAT = {
    analysis:  {e:'ğŸ“Š',l:'ë¶„ì„',  c:'59 130 246'},
    infra:     {e:'âš™ï¸',l:'ì¸í”„ë¼',c:'168 85 247'},
    incident:  {e:'ğŸ”´',l:'ì¥ì• ',  c:'239 68 68'},
    cost:      {e:'ğŸ’°',l:'ë¹„ìš©',  c:'245 158 11'},
    security:  {e:'ğŸ”’',l:'ë³´ì•ˆ',  c:'244 63 94'},
    automation:{e:'ğŸ¤–',l:'ìë™í™”',c:'6 182 212'},
    monitoring:{e:'ğŸ“¡',l:'ëª¨ë‹ˆí„°ë§',c:'249 115 22'},
    docs:      {e:'ğŸ“',l:'ë¬¸ì„œí™”',c:'148 163 184'},
  };

  const STAT = {
    in_progress:{l:'ì§„í–‰ì¤‘',dot:'bg-green-500'},
    waiting:    {l:'ëŒ€ê¸°',  dot:'bg-yellow-500'},
    blocked:    {l:'ì°¨ë‹¨',  dot:'bg-red-500'},
    done:       {l:'ì™„ë£Œ',  dot:'bg-gray-400'},
  };

  const RH = 48;
  const SRH = 36;

  /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let Z = ZOOMS[2], VS = null, D = null, firstScroll = true;
  let expanded = new Set();
  let VR = [];
  let TW = 0, DUR = 0;
  let drag = null;

  /* â”€â”€ Date Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const sod = d => { const r=new Date(d); r.setHours(0,0,0,0); return r; };
  const addD = (d,n) => { const r=new Date(d); r.setDate(r.getDate()+n); return r; };
  const addH = (d,n) => new Date(d.getTime()+n*36e5);
  const isWE = d => d.getDay()===0||d.getDay()===6;
  const same = (a,b) => a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();
  const isNow = d => same(d,new Date());
  const WD = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  function sow(d) {
    const r=sod(d), dy=r.getDay(), diff=dy===0?6:dy-1;
    r.setDate(r.getDate()-diff); return r;
  }

  function fmtD(d) { return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`; }
  function fmtShort(d) { return `${d.getMonth()+1}/${d.getDate()}`; }
  function fmtDateOnly(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  function fmtRange(s,e) {
    const end = addD(e,-1);
    if (same(s,end)) return fmtD(s);
    return `${fmtD(s)} â€“ ${String(end.getMonth()+1).padStart(2,'0')}.${String(end.getDate()).padStart(2,'0')}`;
  }

  function relT(iso) {
    if (!iso) return '';
    const d = Math.floor((Date.now()-new Date(iso).getTime())/1000);
    if (d<60) return 'ë°©ê¸ˆ ì „';
    if (d<3600) return `${Math.floor(d/60)}ë¶„ ì „`;
    if (d<86400) return `${Math.floor(d/3600)}ì‹œê°„ ì „`;
    return `${Math.floor(d/86400)}ì¼ ì „`;
  }

  function toISOKST(d) {
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'),
      dy=String(d.getDate()).padStart(2,'0'), h=String(d.getHours()).padStart(2,'0'),
      mi=String(d.getMinutes()).padStart(2,'0'), s=String(d.getSeconds()).padStart(2,'0');
    return `${y}-${m}-${dy}T${h}:${mi}:${s}+09:00`;
  }

  /* â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function initTheme() {
    const s=localStorage.getItem('theme');
    if (s==='light') document.documentElement.classList.remove('dark');
    else document.documentElement.classList.add('dark');
    updIco();
  }
  function updIco() {
    const dk=document.documentElement.classList.contains('dark');
    document.getElementById('moonIco').classList.toggle('hidden',dk);
    document.getElementById('sunIco').classList.toggle('hidden',!dk);
  }
  document.getElementById('themeBtn').onclick = () => {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('theme', document.documentElement.classList.contains('dark')?'dark':'light');
    updIco();
  };
  initTheme();

  /* â”€â”€ Columns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function getCols() {
    const cols = [];
    if (Z.unit==='hour') {
      for (let d=0; d<Z.days; d++) {
        const day = addD(VS,d);
        for (let h=0; h<24; h++) {
          const showHr = Z.days===1 ? h%2===0 : h%6===0;
          cols.push({
            dt: addH(day,h), w: Z.cpx,
            lbl: showHr ? `${String(h).padStart(2,'0')}:00` : '',
            dayLbl: h===0 ? `${day.getMonth()+1}/${day.getDate()} ${WD[day.getDay()]}` : null,
            we: isWE(day), td: isNow(day), major: h===0,
          });
        }
      }
    } else {
      for (let d=0; d<Z.days; d++) {
        const day = addD(VS,d);
        cols.push({
          dt: day, w: Z.cpx,
          lbl: Z.days<=7 ? `${day.getMonth()+1}/${day.getDate()} ${WD[day.getDay()]}` :
               Z.days<=14 ? `${day.getDate()} ${WD[day.getDay()]}` :
               `${day.getDate()}`,
          dayLbl: Z.days>14 && day.getDate()===1 ? `${day.getMonth()+1}ì›”` : null,
          we: isWE(day), td: isNow(day), major: day.getDay()===1,
        });
      }
    }
    return cols;
  }

  /* â”€â”€ Task date range â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function taskRange(t) {
    const now = new Date();
    let s = t.started_at ? new Date(t.started_at) : new Date(t.updated_at||now);
    let e;
    if (t.due_date) {
      e = new Date(t.due_date+'T23:59:59');
    } else if (t.status==='done') {
      e = new Date(t.updated_at||now);
    } else {
      e = now;
    }
    if (e<=s) e = addD(s,1);
    return {s,e};
  }

  /* â”€â”€ Visible Rows (expand/collapse) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function getVisibleRows() {
    const rows = [];
    (D?.tasks || []).forEach((t, i) => {
      const hasSubs = !!(t.subtasks && t.subtasks.length);
      rows.push({ type:'task', task:t, idx:i, hasSubs });
      if (hasSubs && expanded.has(i)) {
        t.subtasks.forEach((st, si) => {
          rows.push({ type:'sub', task:st, parentIdx:i, subIdx:si, category:t.category });
        });
      }
    });
    return rows;
  }

  function toggleExpand(idx) {
    if (expanded.has(idx)) expanded.delete(idx);
    else expanded.add(idx);
    render();
  }

  /* â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function render() {
    // Zoom bar
    document.getElementById('zoomBar').innerHTML = ZOOMS.map(z =>
      `<button onclick="setZ('${z.id}')" class="px-3 py-1.5 text-xs font-medium transition-colors ${z.id===Z.id?'bg-foreground text-background':'hover:bg-accent text-muted-foreground'}">${z.label}</button>`
    ).join('');

    // Range label
    document.getElementById('rangeLabel').textContent = fmtRange(VS, addD(VS,Z.days));

    if (!D) return;
    const cols = getCols();
    const tw = cols.reduce((s,c)=>s+c.w,0);
    const ve = addD(VS,Z.days);
    const dur = ve.getTime()-VS.getTime();
    TW = tw; DUR = dur;

    VR = getVisibleRows();

    // Date header
    {
      let h = '';
      cols.forEach(c => {
        const tdCls = c.td ? 'bg-blue-500/10 text-blue-500 font-semibold' : '';
        const weCls = c.we && !c.td ? 'bg-muted/30' : '';
        const bCls = c.major ? 'border-border' : 'border-border/30';
        h += `<div class="shrink-0 flex items-center justify-center text-[11px] text-muted-foreground border-r ${bCls} ${weCls} ${tdCls}" style="width:${c.w}px">${c.lbl}</div>`;
      });
      const hdr = document.getElementById('tHeader');
      hdr.innerHTML = h;
      hdr.style.width = tw+'px';
    }

    // Labels
    {
      if (VR.length===0) {
        document.getElementById('labels').innerHTML = `<div class="flex items-center justify-center text-sm text-muted-foreground" style="height:${RH*2}px">ì‘ì—… ì—†ìŒ</div>`;
      } else {
        document.getElementById('labels').innerHTML = VR.map((row, vi) => {
          if (row.type==='task') {
            const t = row.task;
            const cat = CAT[t.category]||{e:'ğŸ“Œ',l:t.category};
            const st = STAT[t.status]||{l:t.status,dot:'bg-gray-400'};
            const hasSubs = row.hasSubs;
            const isExp = expanded.has(row.idx);
            const subCount = hasSubs ? t.subtasks.length : 0;
            return `<div class="flex items-center gap-1.5 px-3 border-b border-border/50 ${hasSubs?'cursor-pointer hover:bg-accent/30':''}" ${hasSubs?`onclick="toggleExpand(${row.idx})"`:''}  style="height:${RH}px">
              ${hasSubs
                ? `<span class="expand-arrow text-[10px] text-muted-foreground w-3 shrink-0 select-none text-center ${isExp?'open':''}">â–¶</span>`
                : '<span class="w-3 shrink-0"></span>'}
              <span class="text-sm shrink-0">${cat.e}</span>
              <div class="min-w-0 flex-1">
                <div class="text-[13px] font-medium truncate leading-tight">${t.title}</div>
                <div class="flex items-center gap-1 mt-0.5">
                  <span class="h-1.5 w-1.5 rounded-full ${st.dot} shrink-0"></span>
                  <span class="text-[10px] text-muted-foreground">${st.l}${t.progress>0&&t.progress<100?' Â· '+t.progress+'%':''}${hasSubs?' Â· '+subCount+'ê°œ':''}</span>
                </div>
              </div>
            </div>`;
          } else {
            const st = row.task;
            const stat = STAT[st.status]||{l:st.status,dot:'bg-gray-400'};
            return `<div class="flex items-center gap-1.5 pl-9 pr-3 border-b border-border/20" style="height:${SRH}px">
              <div class="min-w-0 flex-1">
                <div class="text-[12px] truncate leading-tight text-muted-foreground">${st.title}</div>
                <div class="flex items-center gap-1">
                  <span class="h-1 w-1 rounded-full ${stat.dot} shrink-0"></span>
                  <span class="text-[9px] text-muted-foreground">${stat.l}${st.progress>0&&st.progress<100?' Â· '+st.progress+'%':''}</span>
                </div>
              </div>
            </div>`;
          }
        }).join('');
      }
    }

    // Timeline body
    {
      // Grid bg
      let g = '<div class="absolute inset-0 flex pointer-events-none">';
      cols.forEach(c => {
        const tdCls = c.td ? 'bg-blue-500/[0.03]' : '';
        const weCls = c.we && !c.td ? 'bg-muted/15' : '';
        const bCls = c.major ? 'border-border/60' : 'border-border/20';
        g += `<div class="shrink-0 h-full border-r ${bCls} ${weCls} ${tdCls}" style="width:${c.w}px"></div>`;
      });
      g += '</div>';

      // Rows
      let rows = '';
      VR.forEach((row, vi) => {
        const rh = row.type==='task' ? RH : SRH;
        const t = row.task;
        const catKey = row.type==='task' ? t.category : row.category;
        const cat = CAT[catKey]||{c:'148 163 184'};
        const {s,e} = taskRange(t);
        const l = Math.max(0, (s.getTime()-VS.getTime())/dur);
        const r = Math.min(1, (e.getTime()-VS.getTime())/dur);
        const isSub = row.type==='sub';
        let bar = '';
        if (r>0 && l<1) {
          const lp = l*tw, wp = Math.max(6,(r-l)*tw);
          const rgb = cat.c;
          const oe = !t.due_date && (t.status==='in_progress'||t.status==='blocked');
          const opMul = isSub ? 0.7 : 1;

          let bgStyle='', borderStyle='', fillStyle='', extra='';
          if (t.status==='in_progress') {
            bgStyle = `background:rgba(${rgb},${0.55*opMul})`;
            borderStyle = `border:2px solid rgba(${rgb},${0.9*opMul})`;
            fillStyle = `background:rgba(${rgb},${0.9*opMul})`;
          } else if (t.status==='blocked') {
            bgStyle = `background:rgba(239,68,68,${0.06*opMul})`;
            borderStyle = `border:1px solid rgba(239,68,68,${0.35*opMul})`;
            fillStyle = `background:rgba(239,68,68,${0.3*opMul})`;
            extra = 'bar-stripe';
          } else if (t.status==='done') {
            bgStyle = `background:rgba(${rgb},${0.08*opMul})`;
            borderStyle = `border:1px solid rgba(${rgb},${0.2*opMul})`;
            fillStyle = `background:rgba(${rgb},${0.25*opMul})`;
          } else {
            bgStyle = `background:rgba(${rgb},${0.06*opMul})`;
            borderStyle = `border:1px dashed rgba(${rgb},${0.3*opMul})`;
            fillStyle = `background:rgba(${rgb},${0.15*opMul})`;
            extra = 'bar-dash';
          }

          const rCls = oe ? 'rounded-l-[4px] rounded-r-none border-r-0' : 'rounded-[4px]';
          const topBot = isSub ? 'top-1 bottom-1' : 'top-1.5 bottom-1.5';
          const txtFit = wp > 80;
          const pct = t.progress||0;
          const fontSize = isSub ? 'text-[10px]' : 'text-[11px]';

          bar = `<div class="gantt-bar absolute ${topBot} ${rCls} ${extra} cursor-pointer overflow-hidden"
            style="left:${lp}px;width:${wp}px;${bgStyle};${borderStyle}"
            data-vi="${vi}" onmouseenter="showTip(event,${vi})" onmouseleave="hideTip()">
            <div class="h-full ${oe?'rounded-l-[3px]':'rounded-[3px]'} transition-all" style="width:${pct}%;${fillStyle}"></div>
            ${txtFit?`<span class="absolute inset-0 flex items-center px-2 ${fontSize} font-medium truncate" style="color:${t.status==='in_progress'?'rgba(255,255,255,0.95)':'rgba('+rgb+','+(0.9*opMul)+')'}">${t.title}</span>`:''}
            <div class="drag-handle absolute top-0 bottom-0 left-0 w-[5px] cursor-col-resize z-10 rounded-l-[3px]" style="background:rgba(${rgb},0.4)" data-edge="left" data-vi="${vi}"></div>
            <div class="drag-handle absolute top-0 bottom-0 right-0 w-[5px] cursor-col-resize z-10 rounded-r-[3px]" style="background:rgba(${rgb},0.4)" data-edge="right" data-vi="${vi}"></div>
          </div>`;

          if (oe) {
            bar += `<div class="absolute ${topBot} pointer-events-none" style="left:${lp+wp}px;width:12px;border-top:1px dashed rgba(${rgb},0.3);border-bottom:1px dashed rgba(${rgb},0.3);"></div>`;
          }
        }
        const rowBorder = isSub ? 'border-border/20' : 'border-border/30';
        rows += `<div class="relative border-b ${rowBorder} ${vi%2?'bg-muted/[0.03]':''}" style="height:${rh}px">${bar}</div>`;
      });

      if (VR.length===0) {
        rows = `<div class="flex items-center justify-center text-sm text-muted-foreground" style="height:${RH*2}px;width:${tw}px">íƒ€ì„ë¼ì¸ì— í‘œì‹œí•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</div>`;
      }

      // NOW line
      let now = '';
      const np = (Date.now()-VS.getTime())/dur;
      if (np>=0 && np<=1) {
        const nx = np*tw;
        now = `<div class="absolute top-0 bottom-0 z-20 pointer-events-none" style="left:${nx}px">
          <div class="w-0.5 h-full bg-red-500/70"></div>
          <div class="now-dot absolute -top-1.5 -left-[3px] w-2 h-2 bg-red-500 rounded-full ring-2 ring-card"></div>
        </div>`;
      }

      const body = document.getElementById('tBody');
      body.innerHTML = g + rows + now;
      body.style.width = tw+'px';
      document.getElementById('tWrap').style.width = tw+'px';
    }

    // Schedule
    {
      const sc = D.schedule||[];
      const el = document.getElementById('sched');
      if (!sc.length) { el.innerHTML='<span class="text-sm text-muted-foreground">ì˜¤ëŠ˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</span>'; }
      else {
        const nm = new Date().getHours()*60+new Date().getMinutes();
        el.innerHTML = sc.map(s => {
          const [h,m] = s.time.split(':').map(Number);
          const min = h*60+m;
          const past = nm>min+60, cur = nm>=min&&nm<min+60;
          return `<div class="flex items-center gap-2 rounded-md border border-border px-3 py-1.5 ${past?'opacity-35':''} ${cur?'border-blue-500/50 bg-blue-500/5':''}">
            <span class="text-xs font-mono font-semibold ${cur?'text-blue-500':'text-muted-foreground'}">${s.time}</span>
            <span class="text-sm">${s.label}</span>
            ${cur?'<span class="relative flex h-2 w-2 ml-1"><span class="animate-ping absolute h-full w-full rounded-full bg-blue-400 opacity-75"></span><span class="relative rounded-full h-2 w-2 bg-blue-500"></span></span>':''}
          </div>`;
        }).join('');
      }
    }

    // Scroll to NOW on first load
    if (firstScroll) {
      firstScroll = false;
      requestAnimationFrame(() => scrollNow());
    }
  }

  function scrollNow() {
    const sc = document.getElementById('tScroll');
    const dur = addD(VS,Z.days).getTime()-VS.getTime();
    const np = (Date.now()-VS.getTime())/dur;
    if (np>=0&&np<=1) {
      const tw = parseInt(document.getElementById('tWrap').style.width)||0;
      sc.scrollLeft = Math.max(0, np*tw - sc.offsetWidth/3);
    }
  }

  /* â”€â”€ Tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showTip(ev,vi) {
    if (drag) return;
    const row = VR[vi];
    if (!row) return;
    const t = row.task;
    const catKey = row.type==='task' ? t.category : row.category;
    const cat = CAT[catKey]||{e:'ğŸ“Œ',l:catKey};
    const st = STAT[t.status]||{l:t.status};
    const {s,e} = taskRange(t);
    const tip = document.getElementById('tip');
    const prefix = row.type==='sub' ? '<span class="text-[10px] text-muted-foreground">í•˜ìœ„ì‘ì—…</span><br>' : '';
    tip.innerHTML = `${prefix}<div class="font-semibold mb-1">${cat.e} ${t.title}</div>
      <div class="space-y-0.5 text-xs text-muted-foreground">
        <div><span class="inline-block h-1.5 w-1.5 rounded-full ${st.dot||'bg-gray-400'} mr-1"></span>${st.l} Â· ${t.progress||0}%</div>
        <div>ğŸ“… ${fmtShort(s)} â†’ ${t.due_date?fmtShort(e):'ë¯¸ì •'}</div>
        ${t.note?`<div class="mt-1 text-card-foreground/80">${t.note}</div>`:''}
        ${t.updated_at?`<div class="mt-1 opacity-60">${relT(t.updated_at)} ì—…ë°ì´íŠ¸</div>`:''}
      </div>`;
    tip.classList.remove('hidden');
    const r = tip.getBoundingClientRect();
    let x=ev.clientX+10, y=ev.clientY+10;
    if (x+r.width>innerWidth) x=ev.clientX-r.width-10;
    if (y+r.height>innerHeight) y=ev.clientY-r.height-10;
    tip.style.left=x+'px'; tip.style.top=y+'px';
  }
  function hideTip() { document.getElementById('tip').classList.add('hidden'); }

  /* â”€â”€ Drag Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function pxToDate(px) {
    const ratio = Math.max(0, Math.min(1, px / TW));
    return new Date(VS.getTime() + ratio * DUR);
  }

  function onDragStart(e) {
    const handle = e.target.closest('.drag-handle');
    if (!handle) return;
    e.preventDefault();
    e.stopPropagation();
    hideTip();

    const vi = parseInt(handle.dataset.vi);
    const barEl = handle.closest('.gantt-bar');

    drag = {
      vi,
      edge: handle.dataset.edge,
      startX: e.clientX,
      origLeft: parseFloat(barEl.style.left),
      origWidth: parseFloat(barEl.style.width),
      barEl,
    };

    document.body.classList.add('dragging');
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd);
  }

  function onDragMove(e) {
    if (!drag) return;
    e.preventDefault();

    const dx = e.clientX - drag.startX;

    if (drag.edge === 'right') {
      const nw = Math.max(6, drag.origWidth + dx);
      drag.barEl.style.width = nw + 'px';
    } else {
      const nl = drag.origLeft + dx;
      const nw = Math.max(6, drag.origWidth - dx);
      drag.barEl.style.left = nl + 'px';
      drag.barEl.style.width = nw + 'px';
    }

    // Drag tooltip
    const dtip = document.getElementById('dragTip');
    const barLeft = parseFloat(drag.barEl.style.left);
    const barWidth = parseFloat(drag.barEl.style.width);
    const dateVal = drag.edge === 'left' ? pxToDate(barLeft) : pxToDate(barLeft + barWidth);
    dtip.textContent = fmtD(dateVal);
    dtip.classList.remove('hidden');
    dtip.style.left = (e.clientX + 14) + 'px';
    dtip.style.top = (e.clientY - 32) + 'px';
  }

  function onDragEnd(e) {
    if (!drag) return;

    document.body.classList.remove('dragging');
    document.removeEventListener('mousemove', onDragMove);
    document.removeEventListener('mouseup', onDragEnd);
    document.getElementById('dragTip').classList.add('hidden');

    // Calculate new dates
    const barLeft = parseFloat(drag.barEl.style.left);
    const barWidth = parseFloat(drag.barEl.style.width);
    const row = VR[drag.vi];

    let t;
    if (row.type === 'task') {
      t = D.tasks[row.idx];
    } else {
      t = D.tasks[row.parentIdx].subtasks[row.subIdx];
    }

    if (drag.edge === 'left') {
      const newStart = pxToDate(barLeft);
      t.started_at = toISOKST(newStart);
    } else {
      const newEnd = pxToDate(barLeft + barWidth);
      t.due_date = fmtDateOnly(newEnd);
    }

    drag = null;
    render();
  }

  document.addEventListener('mousedown', e => {
    if (e.target.closest('.drag-handle')) onDragStart(e);
  });

  /* â”€â”€ Status indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setOnline(t) {
    document.getElementById('live').innerHTML=`<span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative rounded-full h-2.5 w-2.5 bg-green-500"></span></span><span>Live</span><span class="opacity-50">Â· ${relT(t)}</span>`;
  }
  function setOff() {
    document.getElementById('live').innerHTML=`<span class="relative flex h-2.5 w-2.5"><span class="relative rounded-full h-2.5 w-2.5 bg-red-500"></span></span><span class="text-red-500">Offline</span>`;
  }

  /* â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function nav(dir) { VS=addD(VS, dir*Z.step); firstScroll=true; render(); }

  function goToday() {
    const td = sod(new Date());
    if (Z.unit==='hour') VS=td;
    else if (Z.days<=7) VS=sow(td);
    else if (Z.days<=14) VS=addD(sow(td),-3);
    else VS=addD(td,-7);
    firstScroll=true; render();
  }

  function setZ(id) {
    const z=ZOOMS.find(z=>z.id===id); if(!z)return;
    Z=z; goToday();
  }

  /* â”€â”€ Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchData() {
    try {
      const r=await fetch('data/status.json',{cache:'no-store'});
      if(!r.ok) throw 0;
      D=await r.json();
      setOnline(D.meta?.updated_at);
      render();
    } catch { setOff(); if(D) render(); }
  }

  /* â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  Z=ZOOMS[2]; goToday(); fetchData();
  setInterval(fetchData, 30000);
  document.addEventListener('keydown', e => {
    if(e.key==='ArrowLeft') nav(-1);
    if(e.key==='ArrowRight') nav(1);
    if(e.key==='t'||e.key==='T') goToday();
  });
  </script>
</body>
</html>
